.PHONY: help dev dev-clean dev-info build test clean run install-deps templ-generate templ-watch check-deps kill-port logs watch

# Default target
.DEFAULT_GOAL := help

# Variables
APP_NAME := shop-server
PORT := 8080

## help: Show this help message
help:
	@echo "Available commands:"
	@echo ""
	@grep -E '^## ' $(MAKEFILE_LIST) | sed 's/^## /  /'
	@echo ""

## dev: Start development server with hot reload (Air)
dev: check-deps
	@echo "ðŸš€ Starting development server with hot reload..."
	@echo "ðŸ“± Open http://localhost:$(PORT) in your browser"
	@echo "ðŸ’¡ Changes to .go and .templ files will trigger automatic rebuild"
	@echo "â±ï¸  Initial build may take a few seconds..."
	@echo ""
	@air

## dev-clean: Clean and start development server
dev-clean: clean kill-port dev

## kill-port: Kill any process running on PORT
kill-port:
	@echo "ðŸ”ª Checking port $(PORT)..."
	@lsof -ti:$(PORT) | xargs kill -9 2>/dev/null || echo "âœ… Port $(PORT) is free"

## check-deps: Check if required tools are installed
check-deps:
	@echo "ðŸ” Checking dependencies..."
	@command -v templ >/dev/null 2>&1 || (echo "âŒ templ not found. Run: make install-deps" && exit 1)
	@command -v air >/dev/null 2>&1 || (echo "âŒ air not found. Run: make install-deps" && exit 1)
	@echo "âœ… All dependencies installed"

## build: Build the application
build: templ-generate
	@echo "ðŸ”¨ Building application..."
	@go build -o $(APP_NAME) .
	@echo "âœ… Build complete: ./$(APP_NAME)"

## run: Build and run the application
run: build
	@echo "ðŸš€ Running application..."
	@./$(APP_NAME)

## test: Run all tests
test:
	@echo "ðŸ§ª Running tests..."
	@go test -v ./...

## test-cover: Run tests with coverage
test-cover:
	@echo "ðŸ§ª Running tests with coverage..."
	@go test -cover ./...
	@go test -coverprofile=coverage.out ./...
	@go tool cover -html=coverage.out -o coverage.html
	@echo "âœ… Coverage report generated: coverage.html"

## clean: Clean build artifacts and temporary files
clean:
	@echo "ðŸ§¹ Cleaning up..."
	@rm -f $(APP_NAME)
	@rm -rf tmp/
	@rm -f build-errors.log
	@rm -f coverage.out coverage.html
	@find . -name "*_templ.go" -type f -delete
	@echo "âœ… Clean complete"

## install-deps: Install development dependencies
install-deps:
	@echo "ðŸ“¦ Installing dependencies..."
	@go install github.com/a-h/templ/cmd/templ@latest
	@go install github.com/air-verse/air@latest
	@go mod download
	@echo "âœ… Dependencies installed"

## templ-generate: Generate Go code from Templ templates
templ-generate:
	@echo "âš¡ Generating Templ templates..."
	@templ generate
	@echo "âœ… Templ generation complete"

## templ-watch: Watch and auto-generate Templ templates
templ-watch:
	@echo "ðŸ‘€ Watching Templ templates for changes..."
	@templ generate --watch

## fmt: Format code
fmt:
	@echo "ðŸŽ¨ Formatting code..."
	@go fmt ./...
	@templ fmt .
	@echo "âœ… Code formatted"

## lint: Run linters (requires golangci-lint)
lint:
	@echo "ðŸ” Running linters..."
	@if command -v golangci-lint >/dev/null 2>&1; then \
		golangci-lint run; \
	else \
		echo "âš ï¸  golangci-lint not installed. Install with:"; \
		echo "    go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest"; \
	fi

## mod-tidy: Tidy go.mod and go.sum
mod-tidy:
	@echo "ðŸ“¦ Tidying modules..."
	@go mod tidy
	@echo "âœ… Modules tidied"

## init: Initialize project (install deps + generate templates)
init: install-deps templ-generate
	@echo "âœ… Project initialized successfully!"
	@echo ""
	@echo "Quick start:"
	@echo "  make dev    - Start development server"
	@echo "  make test   - Run tests"
	@echo "  make build  - Build for production"

## logs: Show Air build logs
logs:
	@if [ -f build-errors.log ]; then \
		echo "ðŸ“‹ Build error logs:"; \
		cat build-errors.log; \
	else \
		echo "âœ… No error logs found"; \
	fi

## watch: Watch mode info
watch:
	@echo "ðŸ‘€ Air is watching these file types:"
	@echo "  - .go files (Go source)"
	@echo "  - .templ files (Templates)"
	@echo ""
	@echo "ðŸ“ Watching directories:"
	@echo "  - models/"
	@echo "  - handlers/"
	@echo "  - templates/"
	@echo "  - . (root)"
	@echo ""
	@echo "ðŸ”„ On change, Air will:"
	@echo "  1. Run 'templ generate'"
	@echo "  2. Build the application"
	@echo "  3. Restart the server"
	@echo ""
	@echo "Start watching with: make dev"

## dev-info: Show development server information
dev-info:
	@echo "ðŸ“Š Development Server Info"
	@echo "=========================="
	@echo "App Name:    $(APP_NAME)"
	@echo "Port:        $(PORT)"
	@echo "URL:         http://localhost:$(PORT)"
	@echo "Hot Reload:  Enabled (Air)"
	@echo ""
	@echo "ðŸ“ Project Structure:"
	@ls -lh | grep '^d' || true
	@echo ""
	@echo "ðŸ“¦ Go Modules:"
	@go list -m all 2>/dev/null | head -5 || echo "Run 'go mod download' first"
